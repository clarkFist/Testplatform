# 分批推送脚本使用说明

## 功能概述

`batch_push.py` 是一个安全的分批提交和推送工具，支持将项目文件按照不同策略分批提交到远程仓库，避免一次性提交过多内容导致的问题。

## 主要特性

- **多种分组策略**：支持按目录结构或文件大小分组
- **智能目录分组**：可以按指定深度的目录结构组织文件
- **安全推送**：每批文件独立提交和推送，失败时不影响其他批次
- **自动重试**：推送失败时自动重试，提高成功率
- **全面文件支持**：支持只推送修改文件或推送项目所有文件
- **详细日志**：提供清晰的执行过程和状态反馈

## 使用方法

### 基本用法

```bash
# 按目录结构分批推送（默认）
python scripts/batch_push.py

# 按文件大小分批推送
python scripts/batch_push.py --grouping size

# 推送项目中的所有文件
python scripts/batch_push.py --all
```

### 高级选项

```bash
# 按二级目录分组，每批最大100MB
python scripts/batch_push.py --grouping directory --depth 2 --batch-size 100

# 推送到指定分支
python scripts/batch_push.py --branch main --remote origin

# 自定义提交信息前缀
python scripts/batch_push.py --commit-prefix "项目文件上传"

# 调整重试参数
python scripts/batch_push.py --retries 5 --delay 10
```

## 参数说明

| 参数 | 默认值 | 说明 |
|------|--------|------|
| `--batch-size` | 50 | 每批最大大小(MB) |
| `--remote` | origin | 远程仓库名 |
| `--branch` | (当前分支) | 目标分支名 |
| `--commit-prefix` | 分批提交 | 提交信息前缀 |
| `--retries` | 3 | 推送失败重试次数 |
| `--delay` | 5 | 重试间隔秒数 |
| `--grouping` | directory | 分组方法：directory(按目录) 或 size(按大小) |
| `--depth` | 1 | 目录深度（仅在按目录分组时有效） |
| `--all` | False | 包含项目中的所有文件，而不仅仅是已修改的文件 |

## 分组策略详解

### 1. 按目录分组 (directory)

按照项目的目录结构来组织文件，相同目录下的文件会被分到同一批次中。

- `--depth 1`：按顶级目录分组（如 `src/`, `docs/`, `scripts/`）
- `--depth 2`：按二级目录分组（如 `src/components/`, `src/utils/`）

**优点**：
- 保持目录结构的完整性
- 便于代码审查和版本管理
- 逻辑相关的文件一起提交

**适用场景**：
- 项目文件较多，目录结构清晰
- 希望按功能模块分批提交
- 首次推送整个项目

### 2. 按大小分组 (size)

按照文件大小将文件分组，小文件优先，确保每批不超过指定大小。

**优点**：
- 控制每批的网络传输量
- 避免大文件阻塞推送过程
- 传输更稳定

**适用场景**：
- 网络环境不稳定
- 包含大量大文件
- 对传输大小有严格限制

## 使用示例

### 场景1：首次推送整个项目

```bash
# 按顶级目录分组，推送所有文件
python scripts/batch_push.py --all --grouping directory --depth 1
```

### 场景2：推送代码修改

```bash
# 只推送修改的文件，按目录分组
python scripts/batch_push.py --grouping directory
```

### 场景3：网络环境不佳

```bash
# 使用小批次和更多重试
python scripts/batch_push.py --batch-size 20 --retries 5 --delay 10
```

### 场景4：推送到新分支

```bash
# 推送到新的功能分支
python scripts/batch_push.py --branch feature-new --all
```

## 安全性说明

1. **分批提交**：每批文件独立提交，失败时不会影响已成功的批次
2. **自动重试**：推送失败时自动重试，提高成功率
3. **确认机制**：执行前会显示详细的分批计划，需要用户确认
4. **错误处理**：完善的错误处理和状态反馈

## 注意事项

1. 确保在git仓库根目录下执行脚本
2. 首次推送可能需要配置远程仓库URL
3. 推送大量文件时，建议在网络稳定的环境下执行
4. 脚本会自动处理分支切换和上游设置

## 故障排除

### 常见问题

1. **"不是git仓库"错误**
   - 确保在git仓库根目录下执行脚本

2. **"远程仓库不存在"**
   - 脚本会引导您添加远程仓库URL

3. **推送失败**
   - 检查网络连接
   - 确认远程仓库权限
   - 可以增加重试次数和延迟时间

4. **分支问题**
   - 脚本会自动检测和处理分支切换
   - 可以手动指定目标分支

### 日志解读

- ✅ 表示操作成功
- ❌ 表示操作失败
- ⚠️ 表示警告信息
- 🔍 表示检查状态
- 📋 表示获取文件列表
- 📦 表示分组信息
- 🚀 表示开始推送
- 🎉 表示完成

## 更新日志

- v2.0：添加按目录分组功能
- v1.0：基础按大小分组功能 